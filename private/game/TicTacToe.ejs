<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title">game | main</title>
    <link href="/asset/fontawesome-free/css/all.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/navigation.css">
    <link rel="stylesheet" href="/css/ticactoe.css">
</head>
<body>

    <div class="navigation">
        <div class="link" onclick="window.location.href='/'" ><i class="fas fa-meteor"></i> Feed</div>
        <div class="link" onclick="window.location.href='/chat'"><i class="fas fa-people-arrows"></i> Message</div>
        <div class="link active"><i class="fas fa-satellite"></i>Game</div> 
        <% if(data[0].username!='none') { %> 
            <div class="profile" onclick="document.getElementById('control').style.display='block'">
                <div class="load-img"><div class="profile-img" style="background-image: url('/img/user/<%= data[0].username %>.jpg');"></div></div>
                <div class="profile-name"><%= data[0].username %></div>
            </div>
        <% } else { %> 
            <div class="profile" onclick="window.location.href='/login?href=/game'">
                <div class="load-img"><div class="profile-img" style="background-image: url('/img/user/none.jpg');"></div></div>
                <div class="profile-name">guest<%= data[0].id %></div>
            </div>
        <% } %> 
    </div>

    <div id="control" style="display: none;">
        <div class="user" >
            <div class="control">
                <div class="go-profile" onclick="window.location.href='/<%= data[0].username %>'">
                    <div class="load-img"><div class="control-img" style="background-image: url('/img/user/<%= data[0].username %>.jpg');"></div></div>
                    <div style="padding-left: 20px;">
                        <%= data[0].username %> <br>
                        go to profile
                    </div>
                </div>
                <div class="control-link" onclick="document.getElementById('control').style.display='none'"><i class="fas fa-meteor"></i> Back to feed</div>
                <!-- <div class="control-link"><i class="fas fa-code"></i> tongog API</div> -->
                <!-- <div class="control-link"><i class="fas fa-sliders-h"></i> Setting</div> -->
                <div class="control-link" onclick="window.location.href='/logout'"><i class="fas fa-sign-out-alt"></i> Log out</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="content">
            <div class="section1">
                <div class="header"><i class="fab fa-buromobelexperte"></i> <%= data[1].header %> 's room</div>
                <div class="board">
                    <div class="grid grid-r"><i class="far fa-circle"></i></div>
                    <div class="grid grid-r"><i class="fas fa-times"></i></div>
                    <div class="grid "><i class="fas fa-times"></i></div>
                    <div class="grid grid-r grid-t"><i class="far fa-circle"></i></div>
                    <div class="grid grid-r grid-t"><i class="fas fa-times"></i></div>
                    <div class="grid grid-t"><i class="far fa-circle"></i></div>
                    <div class="grid grid-r grid-t"><i class="far fa-circle"></i></div>
                    <div class="grid grid-r grid-t"><i class="far fa-circle"></i></div>
                    <div class="grid grid-t"><i class="far fa-circle"></i></div>
                </div>
                <div class="player">
                    <div class="player-header" style="display: block;"><i class="fas fa-user-friends"></i>Players</div>
                    <div class="play">
                        <div class="player-grid" id="player1">
                            <div class="player-name" style="color:#202020"><i class="fas fa-plus-circle"></i></i>waiting player</div>
                        </div>
                        <div class="player-grid">
                            <div class="player-name">VS</div>
                        </div>
                        <div class="player-grid" id="player2">
                            <div class="player-name" style="color:#202020"><i class="fas fa-plus-circle"></i></i>waiting player</div>
                        </div>
                        <div></div>
                        <div onclick="startGame()" id="start-btn" class="option1" style="margin-left: 0; margin-top: 20px; display: none;">start game</div>
                        <div></div>
                    </div>               
                </div>
            </div> 
            
            <div class="section2">
                <div class="player-header">
                    <div class="player-active"><i class="fas fa-user"></i> Visitor</i></div>
                    <div class=""><i class="fas fa-comment-alt"></i> Chat</i></div>
                </div>

                <div id="visitors"></div>

            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var user = '<%= data[0].id %>'

        socket.emit('commit-room',{keyRoom:'<%= data[1].key %>' , keyUser:'<%= data[0].id %>'});
        
        socket.on('send-data-room:<%= data[1].key %>' , (msg) => {
            var info = msg[1]; 
            if(msg[0].keyHeader == user){
                document.getElementById('visitors').innerHTML = '';
                info.map((value , index) => {
                    if(!value.log){
                        if(value.player == msg[0].keyHeader)
                        document.getElementById('visitors').innerHTML += '<div class="player-grid">'
                                                                + '<div class="player-name"><i class="fas fa-crown"></i>guest'+value.player+'</div>'
                                                                + '<div class="option1" onclick="setPlayer1(\''+value.player+'\')">Set player 1</div>'
                                                                + '<div class="option2" onclick="setPlayer2(\''+value.player+'\')">Set player 2</div>'
                                                                + '</div>'
                        else 
                        document.getElementById('visitors').innerHTML += '<div class="player-grid">'
                                                                + '<div class="player-name">guest'+value.player+'</div>'
                                                                + '<div class="option1" onclick="setPlayer1(\''+value.player+'\')">Set player 1</div>'
                                                                + '<div class="option2" onclick="setPlayer2(\''+value.player+'\')">Set player 2</div>'
                                                                + '</div>'
                        if(msg[0].player1 == value.player){
                            document.getElementById('player1').innerHTML = '';
                            document.getElementById('player1').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>guest'+msg[0].player1+'</div><div class="option3" onclick="drop(1)">Drop</div>';
                        }
                        if(msg[0].player2 == value.player){
                            document.getElementById('player2').innerHTML = '';
                            document.getElementById('player2').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>guest'+msg[0].player2+'</div><div class="option3" onclick="drop(2)">Drop</div>';
                        }
                    } else {
                        if(value.player == msg[0].keyHeader)
                        document.getElementById('visitors').innerHTML += '<div class="player-grid">'
                                                                + '<div class="player-name"><i class="fas fa-crown"></i>'+value.player+'</div>'
                                                                + '<div class="option1" onclick="setPlayer1(\''+value.player+'\')">Set player 1</div>'
                                                                + '<div class="option2" onclick="setPlayer2(\''+value.player+'\')">Set player 2</div>'
                                                                + '</div>'
                        else 
                        document.getElementById('visitors').innerHTML += '<div class="player-grid">'
                                                                + '<div class="player-name">'+value.player+'</div>'
                                                                + '<div class="option1" onclick="setPlayer1(\''+value.player+'\')">Set player 1</div>'
                                                                + '<div class="option2" onclick="setPlayer2(\''+value.player+'\')">Set player 2</div>'
                                                                + '</div>'
                        if(msg[0].player1 == value.player){
                            document.getElementById('player1').innerHTML = '';
                            document.getElementById('player1').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>guest'+msg[0].player1+'</div><div class="option3" onclick="drop(1)">Drop</div>';
                        }
                        if(msg[0].player2 == value.player){
                            document.getElementById('player2').innerHTML = '';
                            document.getElementById('player2').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>guest'+msg[0].player2+'</div><div class="option3" onclick="drop(2)">Drop</div>';
                        }
                    }
                })
                if(msg[0].player1 != 0 && msg[0].player2 != 0)
                    document.getElementById('start-btn').style.display = 'block';
                else
                    document.getElementById('start-btn').style.display = 'none';
            } else {
                document.getElementById('visitors').innerHTML = '';
                document.getElementById('visitors').style.display = 'flex';
                info.map((value , index) => {
                    if(!value.log){
                        if(value.player == msg[0].keyHeader)
                        document.getElementById('visitors').innerHTML += '<div class="player-grid" style="margin-right:5px">'
                                                                + '<div class="player-name"><i class="fas fa-crown"></i>guest'+value.player+'</div>'
                                                                + '</div>'
                        else 
                        document.getElementById('visitors').innerHTML += '<div class="player-grid" margin-right:5px">'
                                                                + '<div class="player-name">guest'+value.player+'</div>'
                                                                + '</div>'
                        if(msg[0].player1 == value.player){
                            document.getElementById('player1').innerHTML = '';
                            document.getElementById('player1').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>guest'+msg[0].player1+'</div>';
                        }
                        if(msg[0].player2 == value.player){
                            document.getElementById('player2').innerHTML = '';
                            document.getElementById('player2').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>guest'+msg[0].player2+'</div>';
                        }
                    } else {
                        if(value.player == msg[0].keyHeader)
                        document.getElementById('visitors').innerHTML += '<div class="player-grid" margin-right:5px">'
                                                                + '<div class="player-name"><i class="fas fa-crown"></i>'+value.player+'</div>'
                                                                + '</div>'
                        else 
                        document.getElementById('visitors').innerHTML += '<div class="player-grid" margin-right:5px">'
                                                                + '<div class="player-name">'+value.player+'</div>'
                                                                + '</div>'
                        if(msg[0].player1 == value.player){
                            document.getElementById('player1').innerHTML = '';
                            document.getElementById('player1').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>'+msg[0].player1+'</div>';
                        }
                        if(msg[0].player2 == value.player){
                            document.getElementById('player2').innerHTML = '';
                            document.getElementById('player2').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>'+msg[0].player2+'</div>';
                        }
                    }
                })
            }
            if(!msg[0].player1){
                document.getElementById('player1').innerHTML = '';
                document.getElementById('player1').innerHTML += '<div class="player-name" style="color:#202020"><i class="fas fa-plus-circle"></i></i>waiting player</div>';
            }
            if(!msg[0].player2){
                document.getElementById('player2').innerHTML = '';
                document.getElementById('player2').innerHTML += '<div class="player-name" style="color:#202020"><i class="fas fa-plus-circle"></i></i>waiting player<div>';
            }
        })

        socket.on('update-player:<%= data[1].key %>' , (msg) => {
            if(msg.header == user){
                document.getElementById('player1').innerHTML = '';
                document.getElementById('player1').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>'+msg.player1+'</div><div class="option3" onclick="drop(1)">Drop</div>';
                document.getElementById('player2').innerHTML = '';
                document.getElementById('player2').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>'+msg.player2+'</div><div class="option3" onclick="drop(2)">Drop</div>';
                console.log(msg)
                if(msg.player1 != 0 && msg.player2 != 0)
                    document.getElementById('start-btn').style.display = 'block';
                else 
                    document.getElementById('start-btn').style.display = 'none';
            } else {
                document.getElementById('player1').innerHTML = '';
                document.getElementById('player1').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>'+msg.player1+'</div>';
                document.getElementById('player2').innerHTML = '';
                document.getElementById('player2').innerHTML += '<div class="player-name"><i class="fas fa-user"></i>'+msg.player2+'</div>';
            }
            if(msg.player1 == 0){
                document.getElementById('player1').innerHTML = '<div class="player-name" style="color:#202020"><i class="fas fa-plus-circle"></i></i>waiting player</div>';
            }
            if(msg.player2 == 0){
                document.getElementById('player2').innerHTML = '<div class="player-name" style="color:#202020"><i class="fas fa-plus-circle"></i></i>waiting player</div>';
            }       
        })

        var player1 = '<%= data[1].player1 %>' , player2 = '<%= data[1].player2 %>';
        
        let setPlayer1 = (id) =>{
            player1 = id
            if(player2 == id) {
                player2 = 0;
                socket.emit('set-player',{room :'<%= data[1].key %>' , header :'<%= data[0].id %>' ,player1 : id , player2 : 0})
            } else {
                socket.emit('set-player',{room :'<%= data[1].key %>' , header :'<%= data[0].id %>' ,player1 : id , player2 : player2})
            }
        }

        let setPlayer2 = (id) =>{
            player2 = id
            if(player1 == id) {
                player1 = 0;
                socket.emit('set-player',{room :'<%= data[1].key %>' , header :'<%= data[0].id %>' , player1 : 0 ,player2 : id})
            } else {
                socket.emit('set-player',{room :'<%= data[1].key %>' , header :'<%= data[0].id %>' , player1 : player1 ,player2 : id})
            }
        }

        let drop = (id) => {
            if(id == 1) player1 = 0;
            else player2 = 0;
            socket.emit('set-player',{room :'<%= data[1].key %>' , header :'<%= data[0].id %>' , player1 : player1 ,player2 : player2})
        }
        
        let startGame = () => {
            if(player1&& player2){
                socket.emit('start-game' , {room:'<%= data[1].key %>' , header:'<%= data[0].id %>'})
            }
        }

        var visitorShow = 0
        var visitors = () =>{
            if(visitorShow == 0){
                document.getElementById('visitors').style.display = 'none';
                visitorShow = 1;
            } else {
                document.getElementById('visitors').style.display = 'block';
                visitorShow = 0;
            }
        }
    </script>

</body>
</html>